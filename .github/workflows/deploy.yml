name: Deploy External API to Salesforce

on:
  # Automatically triggers when there is a push to the main branch
  push:
    branches:
      - master
  # Optionally, allow manual triggering of the workflow
  workflow_dispatch:

jobs:
  create-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run : |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
          mkdir ~/sfdx
                  tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
                  echo "$HOME/sfdx/bin" >> $GITHUB_PATH
                  ~/sfdx/bin/sfdx version
      

         # Map branch specific environment variable for authentication
         - name: 'Generate branch specific environment variable name'
         id: authvars 
         shell: bash
         run: |
           branch=${GITHUB_REF##*/} 
           echo "::set-output name=SFDX_URL::SFDX_URL_${branch^^}"
       # Store secret for salesforce org
       - name: 'Populate auth file with SFDX_URL secret'
         shell: bash
         run: |
           echo ${{ secrets[steps.authvars.outputs.SFDX_URL] }} > ./SFDX_URL.txt
       # Authenticate to Salesforce org
       - name: 'Authenticate to Salesforce Org'
         run: sfdx auth:sfdxurl:store -f ./SFDX_URL.txt -a sforg

      - name: Create a New Package Version
        run: |
         PACKAGE_ID="0HogK0000000001SAA"
         sfdx force:package:version:create -p $PACKAGE_ID --installation-key-bypass -w 10 --json | tee package.json